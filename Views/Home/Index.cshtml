@using Microsoft.AspNetCore.Identity
@model List<AiMagicCardsGenerator.Models.Entities.GeneratedCard>
@{
    ViewData["Title"] = "Home";
    var topCards  = ViewBag.TopCards as List<AiMagicCardsGenerator.Models.Entities.GeneratedCard>;
    var userLikes = ViewBag.UserLikes as HashSet<int> ?? new HashSet<int>();
    var isAuth    = User.Identity.IsAuthenticated;
}

@Html.AntiForgeryToken()

<div class="hero-section">
    <h1 class="hero-title" data-aos="fade-up" data-aos-delay="0">
        <i class="fas fa-wand-magic-sparkles"></i>
        MTG Card Generator
    </h1>
    <p class="hero-subtitle" data-aos="fade-up" data-aos-delay="0">
        Create unique AI-powered Magic: The Gathering cards
    </p>
    <div data-aos="fade-up" data-aos-delay="0">
        <a asp-controller="Generator" asp-action="Index" class="cta-btn">
            <i class="fas fa-wand-magic-sparkles"></i>
            Generate Your Card
        </a>
    </div>
</div>

@if (topCards != null && topCards.Any())
{
    <h2 class="section-title">
        <i class="fas fa-trophy"></i>
        Top Rated Cards
    </h2>
    <div class="cards-grid">
        @foreach (var card in topCards)
        {
            <div class="shared-card" data-aos="fade-up">
                <a asp-controller="Generator" asp-action="Result" asp-route-id="@card.Id" class="shared-card-link">
                    <img src="@Url.Action("Image", "Generator", new { id = card.Id })" alt="@card.Name" class="shared-card-image" />
                </a>
                <div class="shared-card-info">
                    <div class="shared-card-name">@card.Name</div>
                    <div class="shared-card-type">@card.TypeLine</div>
                    <div class="shared-card-footer">
                        <span class="shared-card-date">
                            <i class="far fa-calendar"></i>
                            @card.CreatedAt.ToString("MMM dd, yyyy")
                        </span>
                        @if (User.Identity != null && User.Identity.IsAuthenticated)
                        {
                            var liked = userLikes.Contains(card.Id);
                            <button type="button" class="like-btn @(liked ? "liked" : "")" data-card-id="@card.Id">
                                <i class="@(liked ? "fas" : "far") fa-heart"></i>
                                <span class="like-count">@card.Likes</span>
                            </button>
                        }
                        else
                        {
                            <span class="like-display" data-card-id="@card.Id">
                                <i class="fas fa-heart"></i>
                                <span class="like-count">@card.Likes</span>
                            </span>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
}

<h2 class="section-title">
    <i class="fas fa-star"></i>
    Recently Shared
</h2>

@if (Model != null && Model.Any())
{
    <div class="cards-grid">
        @foreach (var card in Model)
        {
            <div class="shared-card" data-aos="fade-up">
                <a asp-controller="Generator" asp-action="Result" asp-route-id="@card.Id" class="shared-card-link">
                    <img src="@Url.Action("Image", "Generator", new { id = card.Id })" alt="@card.Name" class="shared-card-image" />
                </a>
                <div class="shared-card-info">
                    <div class="shared-card-name">@card.Name</div>
                    <div class="shared-card-type">@card.TypeLine</div>
                    <div class="shared-card-footer">
                        <span class="shared-card-date">
                            <i class="far fa-calendar"></i>
                            @card.CreatedAt.ToString("MMM dd, yyyy")
                        </span>
                        @if (isAuth)
                        {
                            var liked = userLikes.Contains(card.Id);
                            <button type="button" class="like-btn @(liked ? "liked" : "")" data-card-id="@card.Id">
                                <i class="@(liked ? "fas" : "far") fa-heart"></i>
                                <span class="like-count">@card.Likes</span>
                            </button>
                        }
                        else
                        {
                            <span class="like-display" data-card-id="@card.Id">
                                <i class="fas fa-heart"></i>
                                <span class="like-count">@card.Likes</span>
                            </span>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
}
else
{
    <div class="empty-state" data-aos="fade-up">
        <div class="empty-state-icon">
            <i class="fas fa-inbox"></i>
        </div>
        <p class="empty-state-text">No cards shared yet. Be the first to create and share a card!</p>
        <a asp-controller="Generator" asp-action="Index" class="cta-btn">
            <i class="fas fa-wand-magic-sparkles"></i>
            Generate Your First Card
        </a>
    </div>
}

@section Scripts {
    <script src="~/js/components/card-likes.js" asp-append-version="true"></script>
    <script>
        const tokenElement = document.querySelector('input[name="__RequestVerificationToken"]');
        const antiForgeryToken = tokenElement ? tokenElement.value : '';
        const isAuthenticated = @Json.Serialize(isAuth);

        if (isAuthenticated && antiForgeryToken) {
            initializeLikeSystem(isAuthenticated, antiForgeryToken);
        }
    </script>
}